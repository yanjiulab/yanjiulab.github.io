<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yjlab.xyz","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"livere","storage":true,"lazyload":false,"nav":null,"activeClass":"livere"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="流量控制 (Traffic Control, TC) 是 Linux 内核提供的流量限速、整形和策略控制机制。它以 qdisc-class-filter 的树形结构来实现对流量的分层控制：">
<meta name="keywords" content="TC">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 流量控制 (Traffic Control)">
<meta property="og:url" content="http://yjlab.xyz/2020/09/10/linux-tc/index.html">
<meta property="og:site_name" content="Yanjiu Lab">
<meta property="og:description" content="流量控制 (Traffic Control, TC) 是 Linux 内核提供的流量限速、整形和策略控制机制。它以 qdisc-class-filter 的树形结构来实现对流量的分层控制：">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yjlab.xyz/2020/09/10/linux-tc/stack-qdisc.jpg">
<meta property="og:image" content="http://yjlab.xyz/2020/09/10/linux-tc/fifo-qdisc.png">
<meta property="og:image" content="http://yjlab.xyz/2020/09/10/linux-tc/pfifo_fast-qdisc.png">
<meta property="og:image" content="http://yjlab.xyz/2020/09/10/linux-tc/sfq-qdisc.png">
<meta property="og:image" content="http://yjlab.xyz/2020/09/10/linux-tc/tbf-qdisc.png">
<meta property="og:updated_time" content="2020-10-21T03:34:31.853Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux 流量控制 (Traffic Control)">
<meta name="twitter:description" content="流量控制 (Traffic Control, TC) 是 Linux 内核提供的流量限速、整形和策略控制机制。它以 qdisc-class-filter 的树形结构来实现对流量的分层控制：">
<meta name="twitter:image" content="http://yjlab.xyz/2020/09/10/linux-tc/stack-qdisc.jpg">

<link rel="canonical" href="http://yjlab.xyz/2020/09/10/linux-tc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Linux 流量控制 (Traffic Control) | Yanjiu Lab</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Yanjiu Lab</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Learning then grokking</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fa fa-home fa-fw"></i>首页</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-book fa-fw"></i>笔记</a>

  </li>


      
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yjlab.xyz/2020/09/10/linux-tc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Yanjiu Li">
      <meta itemprop="description" content="演绎一场技术溯源的盛宴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanjiu Lab">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux 流量控制 (Traffic Control)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-10 09:31:57" itemprop="dateCreated datePublished" datetime="2020-09-10T09:31:57+08:00">2020-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-21 11:34:31" itemprop="dateModified" datetime="2020-10-21T11:34:31+08:00">2020-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OS/" itemprop="url" rel="index"><span itemprop="name">OS</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OS/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>流量控制 (Traffic Control, TC) 是 Linux 内核提供的流量限速、整形和策略控制机制。它以 qdisc-class-filter 的树形结构来实现对流量的分层控制：<br><a id="more"></a></p>
<h1 id="流量控制概念"><a href="#流量控制概念" class="headerlink" title="流量控制概念"></a>流量控制概念</h1><h2 id="整形-Shaping"><a href="#整形-Shaping" class="headerlink" title="整形 (Shaping)"></a>整形 (Shaping)</h2><p>整形器（shaper）是将数据包延迟，从而使得数据包传输速度满足特定速率。</p>
<h2 id="调度-Scheduling"><a href="#调度-Scheduling" class="headerlink" title="调度 (Scheduling)"></a>调度 (Scheduling)</h2><p>调度器（scheduler）负责数据包如何在队列中组织。</p>
<h2 id="分类-Classifying"><a href="#分类-Classifying" class="headerlink" title="分类 (Classifying)"></a>分类 (Classifying)</h2><p>分类器（classifying）将流量分类到不同队列中。</p>
<h2 id="策略-Policing"><a href="#策略-Policing" class="headerlink" title="策略 (Policing)"></a>策略 (Policing)</h2><p>策略器在特定队列中测量和限制流量。</p>
<h2 id="丢弃-Dropping"><a href="#丢弃-Dropping" class="headerlink" title="丢弃 (Dropping)"></a>丢弃 (Dropping)</h2><p>丢弃机制可以将整个数据包、整个流或是整个分类都丢弃掉。</p>
<h2 id="标记-Marking"><a href="#标记-Marking" class="headerlink" title="标记 (Marking)"></a>标记 (Marking)</h2><p>标记是一种更改数据包的机制。</p>
<h1 id="Linux-流量控制组件"><a href="#Linux-流量控制组件" class="headerlink" title="Linux 流量控制组件"></a>Linux 流量控制组件</h1><p>对于流量控制而言，Linux 内核通过几个组件直接或间接的实现了流量控制的若干元素概念。主要以 <code>qdisc-class-filter</code> 的树形结构来实现对流量的分层控制。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>传统元素</th>
<th>Linux 组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>整形 (Shaping)</td>
<td>class 提供整形功能</td>
</tr>
<tr>
<td>调度 (Scheduling)</td>
<td>qdisc 是调度器，可以是简单的 FIFO，也可以是复杂的包含 class 和其他 qdiscs 的 HTB。</td>
</tr>
<tr>
<td>分类 (Classifying)</td>
<td>filter 对象通过 classifier 对象的代理执行分类功能。</td>
</tr>
<tr>
<td>策略 (Policing)</td>
<td>policer 作为 filter 的一部分存在。</td>
</tr>
<tr>
<td>丢弃 (Dropping)</td>
<td>要丢弃流量，需要使用带有“丢弃”动作的 policer 配合 filter 进行过滤。</td>
</tr>
<tr>
<td>标记 (Marking)</td>
<td>dsmark qdisc 用于标记。</td>
</tr>
</tbody>
</table>
</div>
<h2 id="队列调度-qdisc"><a href="#队列调度-qdisc" class="headerlink" title="队列调度 (qdisc)"></a>队列调度 (qdisc)</h2><p>qdisc 是一个调度器，每个输出接口都有一种调度器，默认是 FIFO。Linux 下可用的其他 qdiscs 将根据该调度器的规则重新排列进入调度器队列的数据包。</p>
<p>qdisc 是流量控制的主要组成部分，也称为队列规则 (queuing discipline)，根据有无层级可以划分为两种：</p>
<ul>
<li>分类 qdiscs 可以包括 class，并且提供附加 filter 的接口。</li>
<li>无类 qdiscs 不能包含任何 class，也无法将 filter 附加到无类 qdisc。</li>
</ul>
<p>每个接口都包括两个端口：</p>
<ul>
<li>egress 用于 outbound traffic</li>
<li>ingress 用于 inbound traffic</li>
</ul>
<p>其中，主流和常用的是 egress qdisc，也称为 root qdisc。</p>
<p>对于接口上接受的流量，将进入 ingress qdisc，它不允许创建任何子类，而仅作为可附加过滤器的对象存在。出于实际目的，入口 qdisc 只是一个方便的对象，在其上附加了策略器以限制网络接口上接受的流量。</p>
<p>简而言之，egress qdisc 可以进行更多操作，因为它包含真实的 qdisc 和流量控制系统的全部功能。ingress qdisc 只能支持 policer。</p>
<h2 id="类-class"><a href="#类-class" class="headerlink" title="类 (class)"></a>类 (class)</h2><p>class 只存在于分类 qdisc 中，class 可以包括多个子类或者一个独立的子队列。</p>
<p>任何类都可以附加任意数量的过滤器，使得流量可以进入子类或者重新分类/丢弃进入特定类别的流量。</p>
<p>叶子类是 qdisc 中的终端类，它包含一个 qdisc（默认 FIFO），并且永远不会包含子类。任何包含子类的类都是内部类（或根类），而不是叶子类。</p>
<h2 id="过滤器-filter"><a href="#过滤器-filter" class="headerlink" title="过滤器 (filter)"></a>过滤器 (filter)</h2><p>过滤器是 Linux 流量控制系统中最复杂的组件。过滤器提供了一种方便的机制可以将流量控制的几个关键要素粘合在一起，其最明显的作用是对数据包进行分类，Linux 允许用户使用多个不同的 filter 或单个 filter 将数据包分类到输出队列中。</p>
<ul>
<li>过滤器必须包含分类器部分</li>
<li>过滤器可能包含策略器部分</li>
</ul>
<p>可以将过滤器附加到 <strong>classful qdisc</strong> 或 <strong>class</strong> 上。排队的数据包始终首先进入 root qdisc，在遍历附加到 root qdisc 的 filter 之后，可以将包定向到任何子类（可以具有自己的 filter），在该子类中包可以进行进一步分类。</p>
<h2 id="分类器-classifier"><a href="#分类器-classifier" class="headerlink" title="分类器 (classifier)"></a>分类器 (classifier)</h2><p>可以使用 tc 进行操作的过滤器对象可以使用几种不同的分类机制，其中最常见的是 u32 分类器。u32 分类器允许用户根据数据包的属性选择数据包，分类器是可用作过滤器的一部分的工具，以识别数据包或数据包元数据的特征。Linux 分类器对象类似于流量控制 classifying 概念的基本操作和机制。</p>
<h2 id="策略器-policer"><a href="#策略器-policer" class="headerlink" title="策略器 (policer)"></a>策略器 (policer)</h2><p>策略器的基本机制仅在 Linux 流量控制中用作过滤器的一部分。策略器要求在指定速率之上执行一项操作，而在指定速率之下执行另一项操作。</p>
<p>尽管策略和整形都是限制带宽使用的流量控制的基本元素，但<strong>策略器永远不会延迟流量</strong>，它只能根据指定的标准执行操作。</p>
<h2 id="标识符-handle"><a href="#标识符-handle" class="headerlink" title="标识符 (handle)"></a>标识符 (handle)</h2><p>每个 class 和分类 qdisc 在流量控制结构中都需要一个唯一的标识符，也称为 handle，由 <code>major:minor</code> 两部分数字组成。</p>
<ul>
<li>major：此参数对内核完全没有意义。用户可以使用任意编号方案，但是流量控制结构中具有相同父对象的所有对象必须共享 major 号。对于直接附加到 root qdisc 的对象，常规编号方案从 1 开始。</li>
<li>minor：minor 为 0，则表示该对象是 qdisc，其他值表示该对象是 class，具有共同父母的 class 必须具有唯一的 minor 号。</li>
</ul>
<h1 id="Linux-网络栈与队列"><a href="#Linux-网络栈与队列" class="headerlink" title="Linux 网络栈与队列"></a>Linux 网络栈与队列</h1><p>在数据传输路径上，Linux 网络栈和队列的关系可以简化为下图表示</p>
<p><img src="stack-qdisc.jpg" alt="stack-qdisc"></p>
<p>驱动程序队列（Diver queue）位于网络栈和网络接口控制器（NIC）之间。此队列通常实现为先进先出（FIFO）环形缓冲区，只需将其视为固定大小的缓冲区即可。驱动程序队列不包含数据包数据，它由指向其他数据结构的描述符组成，这些数据称为套接字内核缓冲区（SKB），这些数据结构保存着数据包数据，并在整个内核中使用。</p>
<h1 id="iproute2-工具-tc"><a href="#iproute2-工具-tc" class="headerlink" title="iproute2 工具 (tc)"></a>iproute2 工具 (tc)</h1><p><code>iproute2</code> 是一套命令行实用程序，可操纵内核结构以在计算机上进行 IP 网络配置。其中 <code>tc</code> 是唯一用于流量控制的命令行工具。</p>
<p>tc 命令使用方式：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@leander]<span class="comment"># tc</span></span><br><span class="line">Usage: tc [ OPTIONS ] OBJECT &#123; COMMAND | <span class="built_in">help</span> &#125;</span><br><span class="line"><span class="built_in">where</span>  OBJECT := &#123; qdisc | class | filter &#125;</span><br><span class="line">       OPTIONS := &#123; -s[tatistics] | -d[etails] | -r[aw] &#125;</span><br></pre></td></tr></table></figure></p>
<p>tc qdisc 命令使用方式：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@leander]<span class="comment"># tc qdisc add    \ (1)</span></span><br><span class="line">&gt;                  dev eth0     \ (2)</span><br><span class="line">&gt;                  root         \ (3)</span><br><span class="line">&gt;                  handle 1:0   \ (4)</span><br><span class="line">&gt;                  htb            (5)</span><br></pre></td></tr></table></figure></p>
<p>tc class 命令使用方式：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@leander]<span class="comment"># tc class add    \ (1)</span></span><br><span class="line">&gt;                  dev eth0     \ (2)</span><br><span class="line">&gt;                  parent 1:1   \ (3)</span><br><span class="line">&gt;                  classid 1:6  \ (4)</span><br><span class="line">&gt;                  htb          \ (5)</span><br><span class="line">&gt;                  rate 256kbit \ (6)</span><br><span class="line">&gt;                  ceil 512kbit   (7)</span><br></pre></td></tr></table></figure></p>
<p>tc filter 命令使用方式：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@leander]<span class="comment"># tc filter add               \ (1)</span></span><br><span class="line">&gt;                  dev eth0                 \ (2)</span><br><span class="line">&gt;                  parent 1:0               \ (3)</span><br><span class="line">&gt;                  protocol ip              \ (4)</span><br><span class="line">&gt;                  prio 5                   \ (5)</span><br><span class="line">&gt;                  u32                      \ (6)</span><br><span class="line">&gt;                  match ip port 22 0xffff  \ (7)</span><br><span class="line">&gt;                  match ip tos 0x10 0xff   \ (8)</span><br><span class="line">&gt;                  flowid 1:6               \ (9)</span><br><span class="line">&gt;                  police                   \ (10)</span><br><span class="line">&gt;                  rate 32000bps            \ (11)</span><br><span class="line">&gt;                  burst 10240              \ (12)</span><br><span class="line">&gt;                  mpu 0                    \ (13)</span><br><span class="line">&gt;                  action drop/<span class="built_in">continue</span>       (14)</span><br></pre></td></tr></table></figure></p>
<h1 id="qdisc"><a href="#qdisc" class="headerlink" title="qdisc"></a>qdisc</h1><h2 id="无类-qdisc-Classless-Queuing-Disciplines"><a href="#无类-qdisc-Classless-Queuing-Disciplines" class="headerlink" title="无类 qdisc (Classless Queuing Disciplines)"></a>无类 qdisc (Classless Queuing Disciplines)</h2><h3 id="先入先出队列-FIFO-First-In-First-Out"><a href="#先入先出队列-FIFO-First-In-First-Out" class="headerlink" title="先入先出队列 (FIFO, First-In First-Out)"></a>先入先出队列 (FIFO, First-In First-Out)</h3><p>FIFO 算法构成所有 Linux 网络接口（pfifo_fast）上默认 qdisc 的基础，它不对数据包进行整形或重新排列，而仅仅只是在接收并排队后尽快传输数据包。FIFO qdisc 也是在所有新创建的 class 中使用的 qdisc，直到另一个 qdisc 或一个 class 替换它。</p>
<p><img src="fifo-qdisc.png" alt="fifo-qdisc"></p>
<p>但是，真实的 FIFO qdisc 必须具有大小限制（缓冲区大小），以防止数据包入队速度大于出队速度时产生溢出。Linux 实现了两个基本的 FIFO qdiscs：</p>
<ul>
<li>pfifo 基于字节</li>
<li>bfifo 基于数据包</li>
</ul>
<p>无论使用哪种 FIFO，队列的大小都由参数 limit 定义，对于 pfifo 单位为分组，而对于 bfifo 单位为字节。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc ... add pfifo [ <span class="built_in">limit</span> packets ]</span><br><span class="line"></span><br><span class="line">tc qdisc ... add bfifo [ <span class="built_in">limit</span> bytes ]</span><br></pre></td></tr></table></figure>
<p>对于 pfifo，默认值为接口的 txqueuelen, 可通过 <code>ip</code> 命令或 <code>ifconfig</code> 命令查看，一般为 1000。该值范围为 [0, UINT32_MAX]。</p>
<p>对于 pfifo，默认值为接口的 txqueuelen * MTU，该值范围为 [0, UINT32_MAX] 字节。</p>
<h3 id="快速-FIFO-队列-pfifo-fast"><a href="#快速-FIFO-队列-pfifo-fast" class="headerlink" title="快速 FIFO 队列 (pfifo_fast)"></a>快速 FIFO 队列 (pfifo_fast)</h3><p>快速 FIFO 队列使用了三个 pfifo，并<strong>根据 TOS 字段或者用户自定义的优先级字典</strong>将不同的数据包入队不同的 FIFO，是 Linux 的默认队列实现。</p>
<p><img src="pfifo_fast-qdisc.png" alt="pfifo_fast-qdisc"></p>
<p>需要注意的是，三个队列并非同时出队，当数字较小的队列（高优先级，lower bands）阻塞时，数字较大的队列（低优先级，higher bands）将永远不会出队。</p>
<p>因此该队列可用于流量的优先级处理，这与 prio 队列非常相似。</p>
<h3 id="随机公平队列-SFQ-Stochastic-Fair-Queuing"><a href="#随机公平队列-SFQ-Stochastic-Fair-Queuing" class="headerlink" title="随机公平队列 (SFQ, Stochastic Fair Queuing)"></a>随机公平队列 (SFQ, Stochastic Fair Queuing)</h3><p>随机公平队列也使用了多个 FIFO 队列，与 pfifo_fast 队列依据优先级不同， sfq 队列根据<strong>流 (flow)</strong> 来决定数据包的流向。</p>
<p><img src="sfq-qdisc.png" alt="sfq-qdisc"></p>
<p>默认情况下，sfq 队列的散列函数根据数据包的以下三个值来计算散列值，相同的散列值的数据包视为同一个流，因此会进入相同的队列。</p>
<ul>
<li>Source address</li>
<li>Destination address</li>
<li>Source and Destination port</li>
</ul>
<p>出队时采用 round robin 轮转算法，每个流都按顺序得到发送机会，这也是该队列公平的体现，从而保证了每一个流都不会被其它流所淹没。SFQ 之所以被称为“随机”，是因为它并不是真的为每一个流创建一个队列，而是使用一个散列算法把所有的流映射到有限的几个队列中去。</p>
<p>用户可以通过参数来决定散列的细节，例如：</p>
<ul>
<li>divisor：散列桶的大小。</li>
<li>limit：SFQ 最大长度。</li>
<li>depth：每条流的最大长度。</li>
<li>perturb：每隔多长时间更新一次散列函数，以达到更好的公平性。</li>
<li>… </li>
</ul>
<p>更多参数细节不再列出。</p>
<p>另外，用户可以通过 filter 来改变散列函数，通过允许用户控制使用哪种哈希算法来分配对网络带宽的访问，用户可以达到更公平的带宽实际分配。</p>
<p>sfq 队列的用处在于：如果你的链路已经塞满了，而你想保证不会有某一个流独占出口带宽，使用随机公平队列可以达到此效果。</p>
<h3 id="令牌桶过滤-TBF-Token-Bucket-Filter"><a href="#令牌桶过滤-TBF-Token-Bucket-Filter" class="headerlink" title="令牌桶过滤 (TBF, Token Bucket Filter)"></a>令牌桶过滤 (TBF, Token Bucket Filter)</h3><p>此 qdisc 建立在令牌和存储桶上，它只是对接口上传输的流量进行整形。为了限制数据包从特定接口出队的速度，TBF qdisc 是理想的解决方案，它只是将传输的流量减慢到指定的速率（令牌入桶的速率）。</p>
<p><img src="tbf-qdisc.png" alt="tbf-qdisc"></p>
<p>其 tc 语法如下（为了便于观看做了额外的换行，并且将参数用 <code>**</code>标识）：<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tc  qdisc  ...  tbf </span><br><span class="line">    <span class="built_in">rate</span> *<span class="built_in">rate</span>* </span><br><span class="line">    burst *bytes/<span class="built_in">cell</span>* </span><br><span class="line">    ( latency *ms* | limit *bytes* ) </span><br><span class="line">    [ mpu *bytes* [ peakrate *<span class="built_in">rate</span>* mtu *bytes/<span class="built_in">cell</span>* ] ]</span><br></pre></td></tr></table></figure></p>
<ul>
<li>rate：令牌入桶速率，也就是限制发送的速率。</li>
<li>burst：缓存区最大容量，也就是桶的容量。这决定了瞬发流量的峰值能达到多少，通常更高的整形要求需要更大的缓存。</li>
<li>limit 或 latency：队列中最多允许多少字节等待令牌可用；或者最多允许等待多长时延。超过 limit 或 latency 的部分可能会被丢弃。</li>
<li>mpu：最小分组单位（Minimum Packet Unit）, 它决定了令牌的最低消耗。</li>
</ul>
<div class="note info">
            <p><strong>tbf 队列是 classless 还是 classful ?</strong><br>在 tc 主文档（man page）和各类教程中，tbf 队列是无类 qdisc，但是 <code>man tc-tbf</code> 可以发现在描述开头就指出其为分类队列：</p><blockquote><p>The Token Bucket Filter is a classful queueing discipline available for traffic control with the tc(8) command.</p></blockquote><p>通过实践可以发现每当创建一个 tbf qdisc 时，便会同时生成一个对应的 class。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tc qdisc add dev veth handle 1: root tbf burst 20480 <span class="built_in">limit</span> 20480 mtu 1514 rate 32000bps</span><br><span class="line">$ tc qdisc show dev veth </span><br><span class="line">qdisc tbf 1: root refcnt 2 rate 256Kbit burst 20Kb lat 0us </span><br><span class="line">$ tc class show dev veth </span><br><span class="line">class tbf 1:1 parent 1: </span><br></pre></td></tr></table></figure><p>当有其他 qdisc 指定该 tbf 为 parent 时，该 class 将会增加 leaf 字段。有趣的是，即使其他 qdisc 的 parent-id 不为 1:1（例如 1:4），但只要 parent-id 的 major 值为 tbf 的 handle 值即可作为 tbf 的叶子队列。如果此时有另一个 qdisc 将 parent-id 设置为 1:1 时，也就是将 tbf qdisc 作为 classful qdisc 使用，将会报错。</p><p>综上所述，tbf 实现上为 classful qdisc，因为其有默认 class，同时在语义上保留了 classless 的特点，因为 tbf 无法完成分流的功能， 这个特性使得用户可以方便的将 tbf 串联进某个 qdisc 处理链的中间用于限制带宽。具体见实践章节。</p>
          </div>
<h3 id="网络模拟器-NETEM-Network-Emulator"><a href="#网络模拟器-NETEM-Network-Emulator" class="headerlink" title="网络模拟器 (NETEM, Network Emulator)"></a>网络模拟器 (NETEM, Network Emulator)</h3><p>网络模拟器是流量控制系统的一个增强工具，可以在接口的输出端增加一些网络数据包特性，包括：时延、丢包、重复等。</p>
<h2 id="分类-qdisc-Classful-Queuing-Disciplines"><a href="#分类-qdisc-Classful-Queuing-Disciplines" class="headerlink" title="分类 qdisc (Classful Queuing Disciplines)"></a>分类 qdisc (Classful Queuing Disciplines)</h2><h3 id="分层令牌桶-HTB-Hierarchical-Token-Bucket"><a href="#分层令牌桶-HTB-Hierarchical-Token-Bucket" class="headerlink" title="分层令牌桶 (HTB, Hierarchical Token Bucket)"></a>分层令牌桶 (HTB, Hierarchical Token Bucket)</h3><p>见实践相关章节</p>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="搭建本地环境"><a href="#搭建本地环境" class="headerlink" title="搭建本地环境"></a>搭建本地环境</h2><p>利用 Linux 命名空间隔离机制，搭建一个本地的测试环境，在虚拟网卡上进行 tc 命令的测试，不影响机器当前的物理网卡设置。</p>
<figure class="highlight sh"><figcaption><span>config.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ip netns add tcns</span><br><span class="line">ip link add veth <span class="built_in">type</span> veth peer name eth0</span><br><span class="line">ip link <span class="built_in">set</span> eth0 netns tcns</span><br><span class="line">ip address add 192.168.1.1/24 dev veth</span><br><span class="line">ip netns <span class="built_in">exec</span> tcns ip addr add 192.168.1.2/24 dev eth0</span><br><span class="line">ip link <span class="built_in">set</span> veth up</span><br><span class="line">ip netns <span class="built_in">exec</span> tcns ip link <span class="built_in">set</span> eth0 up</span><br><span class="line">ip address show veth</span><br><span class="line">ip netns <span class="built_in">exec</span> tcns ip address show eth0</span><br></pre></td></tr></table></figure>
<p>根据以上脚本可以搭建一个 tcns 命名空间，其 IP 地址为 192.168.1.2/24，接口为 eth0；可以在本机执行 ping 192.168.1.2 测试联通性。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo sh config.sh       # 设置环境</span><br><span class="line">sudo<span class="built_in"> ip </span>netns del tcns  # 清空设置</span><br><span class="line">ping 192.168.1.2        # 测试联通性</span><br></pre></td></tr></table></figure>
<p>我们所有的 tc 设置都设置到 veth 接口，从而验证流量控制。</p>
<h2 id="限制带宽"><a href="#限制带宽" class="headerlink" title="限制带宽"></a>限制带宽</h2><p>使用令牌桶 qdisc 将接口最高速率限制到 256Kbit/s，设置缓冲区和最大排队字节数均为 20Kb，没有时延。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tc qdisc <span class="keyword">add </span>dev veth handle <span class="number">1</span>:<span class="number">0</span> root tbf <span class="keyword">burst </span><span class="number">20480</span> limit <span class="number">20480</span> mtu <span class="number">1514</span> rate <span class="number">32000</span>bps</span><br><span class="line">$ tc qdisc <span class="keyword">show </span>dev veth</span><br><span class="line">qdisc dsmark <span class="number">1</span>: root refcnt <span class="number">2</span> indices <span class="number">0x0001</span> default_index <span class="number">0x0000</span> </span><br><span class="line">qdisc tbf <span class="number">2</span>: parent <span class="number">1</span>: rate <span class="number">256</span>Kbit <span class="keyword">burst </span><span class="number">20</span>Kb lat <span class="number">0</span>us</span><br></pre></td></tr></table></figure></p>
<p>使用 iperf 工具测速，结果如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo<span class="built_in"> ip </span>netns exec tcns iperf -s </span><br><span class="line">Server listening on TCP<span class="built_in"> port </span>5001</span><br><span class="line">TCP window size:  128 KByte (default)</span><br><span class="line">[  4] local 192.168.1.2<span class="built_in"> port </span>5001 connected with 192.168.1.1<span class="built_in"> port </span>34594</span><br><span class="line">[ ID] Interval       Transfer     Bandwidth</span><br><span class="line">[  4]  0.0-15.8 sec   489 KBytes   254 Kbits/sec</span><br></pre></td></tr></table></figure></p>
<h2 id="模拟时延和丢包"><a href="#模拟时延和丢包" class="headerlink" title="模拟时延和丢包"></a>模拟时延和丢包</h2><p>使用 netem 来模拟一些物理特性，这里设置了 5ms 时延和 5%丢包。<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tc qdisc add dev veth handle <span class="number">1</span>:<span class="number">0</span> root netem <span class="built_in">delay</span> 5ms loss <span class="number">5</span><span class="symbol">%</span></span><br><span class="line">$ tc qdisc <span class="built_in">show</span> dev veth </span><br><span class="line">qdisc netem <span class="number">1</span>: root refcnt <span class="number">2</span> <span class="built_in">limit</span> <span class="number">1000</span> <span class="built_in">delay</span> <span class="number">5.</span><span class="number">0ms</span> loss <span class="number">5</span><span class="symbol">%</span></span><br></pre></td></tr></table></figure></p>
<p>使用 ping 命令测试一下<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> ping </span>192.168.1.2</span><br><span class="line">PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.1.2: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=5.09 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.1.2: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=5.18 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.1.2: <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=5.27 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.1.2: <span class="attribute">icmp_seq</span>=4 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=5.08 ms</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line">--- 192.168.1.2<span class="built_in"> ping </span>statistics ---</span><br><span class="line">24 packets transmitted, 23 received, 4.16667% packet loss, time 23045ms</span><br><span class="line">rtt min/avg/max/mdev = 5.080/5.184/5.273/0.062 ms</span><br></pre></td></tr></table></figure></p>
<p>除了 delay 和 loss 常规设置之外，还可以：</p>
<ul>
<li>通过 distribution 设置时延的分布函数。</li>
<li>通过一些参数可以为丢包率的设置引入一些概率分布和随机性。</li>
<li>通过 corrupt 设置噪声导致的比特错误，支持引入相关性等参数。</li>
<li>通过 duplicate 设置包重复率，支持引入相关性等参数。</li>
<li></li>
</ul>
<h2 id="综合：限制带宽-模拟时延和丢包"><a href="#综合：限制带宽-模拟时延和丢包" class="headerlink" title="综合：限制带宽+模拟时延和丢包"></a>综合：限制带宽+模拟时延和丢包</h2><p>通过 tbf 和 netem 结合使用同时限制带宽，并且为接口增加时延。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tc qdisc <span class="keyword">add</span><span class="bash"> dev veth handle 1: root netem <span class="built_in">limit</span> 10240 delay 10ms loss 5%</span></span><br><span class="line">$ sudo tc qdisc <span class="keyword">add</span><span class="bash"> dev veth handle 10: parent 1:1 tbf burst 20480 <span class="built_in">limit</span> 20480 mtu 1514 rate 32000bps</span></span><br><span class="line">$ sudo tc qdisc show dev veth</span><br><span class="line">qdisc netem <span class="number">1</span>: root refcnt <span class="number">2</span> limit <span class="number">10240</span> delay <span class="number">20.0</span>ms loss <span class="number">5</span>%</span><br><span class="line">qdisc tbf <span class="number">10</span>: parent <span class="number">1</span>:<span class="number">1</span> rate <span class="number">256</span>Kbit burst <span class="number">20</span>Kb lat <span class="number">0</span>us </span><br></pre></td></tr></table></figure>
<p>重复上述测试方法，可以看到参数设置生效。</p>
<div class="note info">
            <p>netem 中也有设置 rate 的参数，但是限速会一定程度上影响 delay，因此通过 tbf 来进行限制带宽更加精准。</p>
          </div>
<h2 id="多级流量分类"><a href="#多级流量分类" class="headerlink" title="多级流量分类"></a>多级流量分类</h2><p>使用分层令牌桶完成多级流量分类。</p>
<p>首先在接口的 root 处创建一个 htb qdisc，设置默认类为 1:30。接着创建一个根分类以及三个子类，并设置相应的速率，同时包括 burst 以及 ceil。最后为</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev veth root handle 1: htb default 30</span><br><span class="line">tc class add dev veth parent 1: classid 1:1 htb rate 6mbit burst 15k</span><br><span class="line">tc class add dev veth parent 1:1 classid 1:10 htb rate 5mbit burst 15k</span><br><span class="line">tc class add dev veth parent 1:1 classid 1:20 htb rate 3mbit ceil 6mbit burst 15k</span><br><span class="line">tc class add dev veth parent 1:1 classid 1:30 htb rate 1kbit ceil 6mbit burst 15k</span><br><span class="line"></span><br><span class="line">tc qdisc add dev veth parent 1:10 handle 10: sfq perturb 10</span><br><span class="line">tc qdisc add dev veth parent 1:20 handle 20: sfq perturb 10</span><br><span class="line">tc qdisc add dev veth parent 1:30 handle 30: sfq perturb 10</span><br></pre></td></tr></table></figure>
<p>查看创建的 qdisc 以及 class：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tc qdisc show dev veth </span><br><span class="line">qdisc htb 1: root refcnt 2 r2q 10 default 0x30 direct_packets_stat 24 direct_qlen 1000</span><br><span class="line">qdisc sfq 10: parent 1:10 <span class="built_in">limit</span> 127p quantum 1514b depth 127 divisor 1024 perturb 10sec </span><br><span class="line">qdisc sfq 20: parent 1:20 <span class="built_in">limit</span> 127p quantum 1514b depth 127 divisor 1024 perturb 10sec </span><br><span class="line">qdisc sfq 30: parent 1:30 <span class="built_in">limit</span> 127p quantum 1514b depth 127 divisor 1024 perturb 10sec </span><br><span class="line"></span><br><span class="line">$ tc class show dev veth </span><br><span class="line">class htb 1:1 root rate 6Mbit ceil 6Mbit burst 15Kb cburst 1599b </span><br><span class="line">class htb 1:10 parent 1:1 leaf 10: prio 0 rate 5Mbit ceil 5Mbit burst 15Kb cburst 1600b </span><br><span class="line">class htb 1:20 parent 1:1 leaf 20: prio 0 rate 3Mbit ceil 6Mbit burst 15Kb cburst 1599b </span><br><span class="line">class htb 1:30 parent 1:1 leaf 30: prio 0 rate 1Kbit ceil 6Mbit burst 15Kb cburst 1599b </span><br></pre></td></tr></table></figure>
<p>使用 iperf 测试带宽为 5.75M，因为此时没有别的流量，其 ceil 值生效。查看统计信息确认所有流量进入了 30: 队列。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ tc -s qdisc show dev veth </span><br><span class="line">qdisc htb 1: root refcnt 2 r2q 10 default 0x30 direct_packets_stat 24 direct_qlen 1000</span><br><span class="line"> Sent 7956658 bytes 5291 pkt (dropped 0, overlimits 3100 requeues 0) </span><br><span class="line"> backlog 0b 0p requeues 0</span><br><span class="line">qdisc sfq 30: parent 1:30 <span class="built_in">limit</span> 127p quantum 1514b depth 127 divisor 1024 perturb 10sec </span><br><span class="line"> Sent 7950694 bytes 5263 pkt (dropped 0, overlimits 0 requeues 0) </span><br><span class="line"> backlog 0b 0p requeues 0</span><br><span class="line">qdisc sfq 10: parent 1:10 <span class="built_in">limit</span> 127p quantum 1514b depth 127 divisor 1024 perturb 10sec </span><br><span class="line"> Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) </span><br><span class="line"> backlog 0b 0p requeues 0</span><br><span class="line">qdisc sfq 20: parent 1:20 <span class="built_in">limit</span> 127p quantum 1514b depth 127 divisor 1024 perturb 10sec </span><br><span class="line"> Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) </span><br><span class="line"> backlog 0b 0p requeues 0</span><br></pre></td></tr></table></figure>
<p>一旦在 root 上设置了分类 qdisc 以及 class，就必须使用 filter 来指示哪个类应处理哪个包。接下来使用 filter 来将流量分到不同的 class 中。</p>
<p>我们采用如下的过滤方案：</p>
<ul>
<li>TCP 目的端口为 5001 的包进入 1:10 class 处理</li>
<li>TCP 目的端口为 5002 的包进入 1:20 class 处理</li>
<li>IP 目的地址为 192.168.1.2/32 的包进入 1:30 class 处理</li>
<li>其余默认走 1:30 类</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tc filter add dev veth protocol ip parent 1: prio 1 u32 match ip dport 5001 0xffff flowid 1:10</span><br><span class="line">tc filter add dev veth protocol ip parent 1: prio 1 u32 match ip dport 5002 0xffff flowid 1:20</span><br><span class="line">tc filter add dev veth protocol ip parent 1: prio 2 u32 match ip dst 192.168.1.2/32 flowid 1:30</span><br></pre></td></tr></table></figure>
<p>使用 iperf 测试，在 192.168.1.2 上建立两个 tcp server 分别监听 5001 和 5002 端口，观察过滤情况。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://tldp.org/HOWTO/Traffic-Control-HOWTO/index.html" target="_blank" rel="noopener">Traffic Control HOWTO</a></li>
<li><a href="https://www.linuxjournal.com/content/queueing-linux-network-stack" target="_blank" rel="noopener">Queueing in the Linux Network Stack</a></li>
<li><a href="https://www.cs.unm.edu/~crandall/netsfall13/TCtutorial.pdf" target="_blank" rel="noopener">Traffic Control Manual For Lab1</a></li>
<li><a href="http://home.ifi.uio.no/paalh/students/AndersMoe.pdf" target="_blank" rel="noopener">Implementing Rate Control in NetEm</a></li>
<li><a href="https://wiki.linuxfoundation.org/networking/netem" target="_blank" rel="noopener">Netem wiki</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Advanced_traffic_control" target="_blank" rel="noopener">Advanced traffic control, Archwiki</a></li>
</ul>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/uploads/wechatpay.png" alt="Yanjiu Li 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/uploads/alipay.jpeg" alt="Yanjiu Li 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/TC/" rel="tag"><i class="fa fa-tag"></i> TC</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/01/network-local-socket/" rel="prev" title="Network Local Socket">
      <i class="fa fa-chevron-left"></i> Network Local Socket
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/09/15/os-cache/" rel="next" title="缓存 (Cache)">
      缓存 (Cache) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC80MTAzMS8xNzU1Ng=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#流量控制概念"><span class="nav-number">1.</span> <span class="nav-text">流量控制概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#整形-Shaping"><span class="nav-number">1.1.</span> <span class="nav-text">整形 (Shaping)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调度-Scheduling"><span class="nav-number">1.2.</span> <span class="nav-text">调度 (Scheduling)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分类-Classifying"><span class="nav-number">1.3.</span> <span class="nav-text">分类 (Classifying)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#策略-Policing"><span class="nav-number">1.4.</span> <span class="nav-text">策略 (Policing)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#丢弃-Dropping"><span class="nav-number">1.5.</span> <span class="nav-text">丢弃 (Dropping)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#标记-Marking"><span class="nav-number">1.6.</span> <span class="nav-text">标记 (Marking)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-流量控制组件"><span class="nav-number">2.</span> <span class="nav-text">Linux 流量控制组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#队列调度-qdisc"><span class="nav-number">2.1.</span> <span class="nav-text">队列调度 (qdisc)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类-class"><span class="nav-number">2.2.</span> <span class="nav-text">类 (class)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过滤器-filter"><span class="nav-number">2.3.</span> <span class="nav-text">过滤器 (filter)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分类器-classifier"><span class="nav-number">2.4.</span> <span class="nav-text">分类器 (classifier)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#策略器-policer"><span class="nav-number">2.5.</span> <span class="nav-text">策略器 (policer)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#标识符-handle"><span class="nav-number">2.6.</span> <span class="nav-text">标识符 (handle)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-网络栈与队列"><span class="nav-number">3.</span> <span class="nav-text">Linux 网络栈与队列</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iproute2-工具-tc"><span class="nav-number">4.</span> <span class="nav-text">iproute2 工具 (tc)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#qdisc"><span class="nav-number">5.</span> <span class="nav-text">qdisc</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#无类-qdisc-Classless-Queuing-Disciplines"><span class="nav-number">5.1.</span> <span class="nav-text">无类 qdisc (Classless Queuing Disciplines)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#先入先出队列-FIFO-First-In-First-Out"><span class="nav-number">5.1.1.</span> <span class="nav-text">先入先出队列 (FIFO, First-In First-Out)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#快速-FIFO-队列-pfifo-fast"><span class="nav-number">5.1.2.</span> <span class="nav-text">快速 FIFO 队列 (pfifo_fast)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#随机公平队列-SFQ-Stochastic-Fair-Queuing"><span class="nav-number">5.1.3.</span> <span class="nav-text">随机公平队列 (SFQ, Stochastic Fair Queuing)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#令牌桶过滤-TBF-Token-Bucket-Filter"><span class="nav-number">5.1.4.</span> <span class="nav-text">令牌桶过滤 (TBF, Token Bucket Filter)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网络模拟器-NETEM-Network-Emulator"><span class="nav-number">5.1.5.</span> <span class="nav-text">网络模拟器 (NETEM, Network Emulator)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分类-qdisc-Classful-Queuing-Disciplines"><span class="nav-number">5.2.</span> <span class="nav-text">分类 qdisc (Classful Queuing Disciplines)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分层令牌桶-HTB-Hierarchical-Token-Bucket"><span class="nav-number">5.2.1.</span> <span class="nav-text">分层令牌桶 (HTB, Hierarchical Token Bucket)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实践"><span class="nav-number">6.</span> <span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建本地环境"><span class="nav-number">6.1.</span> <span class="nav-text">搭建本地环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限制带宽"><span class="nav-number">6.2.</span> <span class="nav-text">限制带宽</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模拟时延和丢包"><span class="nav-number">6.3.</span> <span class="nav-text">模拟时延和丢包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#综合：限制带宽-模拟时延和丢包"><span class="nav-number">6.4.</span> <span class="nav-text">综合：限制带宽+模拟时延和丢包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多级流量分类"><span class="nav-number">6.5.</span> <span class="nav-text">多级流量分类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yanjiu Li"
      src="/uploads/avatar.png">
  <p class="site-author-name" itemprop="name">Yanjiu Li</p>
  <div class="site-description" itemprop="description">演绎一场技术溯源的盛宴</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yanjiulab" title="GitHub → https://github.com/yanjiulab" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liyanjiu@outlook.com" title="E-Mail → mailto:liyanjiu@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Worth Reading
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://pages.cs.wisc.edu/~remzi/OSTEP" title="http://pages.cs.wisc.edu/~remzi/OSTEP" rel="noopener" target="_blank">OSTEP</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/Chinese/" title="http://pages.cs.wisc.edu/~remzi/OSTEP/Chinese/" rel="noopener" target="_blank">OSTEP-Chinese</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.apuebook.com/about3e.html" title="http://www.apuebook.com/about3e.html" rel="noopener" target="_blank">APUE</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://mathcs.clarku.edu/~jbreecher/cs280/UNIX%20Network%20Programming(Volume1,3rd).pdf" title="https://mathcs.clarku.edu/~jbreecher/cs280/UNIX%20Network%20Programming(Volume1,3rd).pdf" rel="noopener" target="_blank">UNP</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://cse.buffalo.edu/~hungngo/classes/TMA-Training/UNP/" title="https://cse.buffalo.edu/~hungngo/classes/TMA-Training/UNP/" rel="noopener" target="_blank">IUNP</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.yinwang.org/" title="http://www.yinwang.org/" rel="noopener" target="_blank">当然我在扯淡</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yanjiu Li</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">217k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:17</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
